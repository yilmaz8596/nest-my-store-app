<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= product.name %> - My Store</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <style>
      .product-image {
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }
      .product-image:hover {
        transform: scale(1.02);
      }
      .price-tag {
        font-size: 2rem;
        font-weight: bold;
        color: #28a745;
      }
      .action-buttons .btn {
        border-radius: 25px;
        padding: 12px 30px;
        font-weight: 600;
        transition: all 0.3s ease;
      }
      .action-buttons .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .product-details {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        padding: 2rem;
      }
      .breadcrumb {
        background: transparent;
        padding: 0;
      }
      .breadcrumb-item + .breadcrumb-item::before {
        content: '>';
        color: #6c757d;
      }
    </style>
  </head>
  <body class="bg-light">
    <%- include('./includes/navbar.ejs') %>

    <div class="container mt-4">
      <!-- Breadcrumb Navigation -->
      <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="/mystore/home" class="text-decoration-none">
              <i class="fas fa-home"></i> Store
            </a>
          </li>
          <li class="breadcrumb-item active" aria-current="page">
            <%= product.name %>
          </li>
        </ol>
      </nav>

      <!-- Product Detail Section -->
      <div class="row g-4">
        <!-- Product Image -->
        <div class="col-md-6">
          <div class="text-center">
            <img
              src="<%= product.img %>"
              alt="<%= product.name %>"
              class="img-fluid product-image"
              style="max-height: 500px; width: 100%; object-fit: cover"
            />
          </div>
        </div>

        <!-- Product Information -->
        <div class="col-md-6">
          <div class="product-details h-100 d-flex flex-column">
            <!-- Product Title -->
            <h1 class="display-5 fw-bold text-dark mb-3">
              <%= product.name %>
            </h1>

            <!-- Product Price -->
            <div class="price-tag mb-4">$<%= product.price %></div>

            <!-- Product Description -->
            <div class="mb-4 flex-grow-1">
              <h5 class="fw-bold text-secondary mb-3">
                <i class="fas fa-info-circle"></i> Product Description
              </h5>
              <p class="lead text-muted"><%= product.description %></p>
            </div>

            <!-- Product Features (Optional) -->
            <div class="mb-4">
              <h6 class="fw-bold text-secondary mb-3">
                <i class="fas fa-star"></i> Key Features
              </h6>
              <ul class="list-unstyled">
                <li class="mb-2">
                  <i class="fas fa-check text-success me-2"></i>
                  High Quality Product
                </li>
                <li class="mb-2">
                  <i class="fas fa-check text-success me-2"></i>
                  Fast Shipping Available
                </li>
                <li class="mb-2">
                  <i class="fas fa-check text-success me-2"></i>
                  30-Day Return Policy
                </li>
                <li class="mb-2">
                  <i class="fas fa-check text-success me-2"></i>
                  Customer Support Included
                </li>
              </ul>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons mt-auto">
              <div class="d-grid gap-3">
                
                <% if(user && user.role === 'admin') { %>
                  <!-- Admin Actions (Edit/Delete) -->
                  <div class="row g-2">
                    <div class="col-6">
                      <a
                        href="/mystore/edit-product/<%= product.id %>"
                        class="btn btn-warning w-100"
                      >
                        <i class="fas fa-edit me-2"></i>
                        Edit Product
                      </a>
                    </div>
                    <div class="col-6">
                      <button
                        class="btn btn-danger w-100"
                        onclick="deleteProduct(<%= product.id %>)"
                      >
                        <i class="fas fa-trash me-2"></i>
                        Delete
                      </button>
                    </div>
                  </div>
                <% } else { %>
                  <!-- Buy Now Button for non-admin users -->
                  <button
                    class="btn btn-success btn-lg"
                    onclick="buyNow('<%= product.name %>', <%= product.price %>)"
                  >
                    <i class="fas fa-shopping-cart me-2"></i>
                    Buy Now - $<%= product.price %>
                  </button>
                <% } %>

                <!-- Back to Store -->
                <a href="/mystore/home" class="btn btn-outline-secondary">
                  <i class="fas fa-arrow-left me-2"></i>
                  Back to Store
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Additional Product Information -->
      <div class="row mt-5">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
              <h5 class="card-title mb-0">
                <i class="fas fa-info-circle me-2"></i>
                Additional Information
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-4 mb-3">
                  <h6 class="fw-bold">Product ID</h6>
                  <p class="text-muted">#<%= product.id %></p>
                </div>
                <div class="col-md-4 mb-3">
                  <h6 class="fw-bold">Availability</h6>
                  <span class="badge bg-success">In Stock</span>
                </div>
                <div class="col-md-4 mb-3">
                  <h6 class="fw-bold">Category</h6>
                  <p class="text-muted">Electronics</p>
                </div>
              </div>
              <hr />
              <div class="row">
                <div class="col-md-6 mb-3">
                  <h6 class="fw-bold">Shipping</h6>
                  <p class="text-muted">
                    <i class="fas fa-truck me-2"></i>
                    Free shipping on orders over $50
                  </p>
                </div>
                <div class="col-md-6 mb-3">
                  <h6 class="fw-bold">Returns</h6>
                  <p class="text-muted">
                    <i class="fas fa-undo me-2"></i>
                    30-day return policy
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script>
      // Buy Now Function (Stripe Integration)
      async function buyNow(productName, price) {
        try {
          const response = await fetch('/stripe/create-checkout-session', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              product_name: productName,
              amount: price,
              quantity: 1,
              success_url: window.location.origin + '/success',
              cancel_url: window.location.origin + '/cancel',
            }),
          });

          const session = await response.json();

          if (session.url) {
            window.location.href = session.url;
          } else {
            alert('Error creating checkout session');
          }
        } catch (error) {
          console.error('Error:', error);
          alert(
            'Payment service temporarily unavailable. Please try again later.',
          );
        }
      }

      // Delete Product Function
      function deleteProduct(productId) {
        if (
          confirm(
            'Are you sure you want to delete this product? This action cannot be undone.',
          )
        ) {
          fetch(`/mystore/products/${productId}`, {
            method: 'DELETE',
          })
            .then((response) => {
              if (response.ok) {
                alert('Product deleted successfully!');
                window.location.href = '/mystore/home';
              } else {
                alert('Error deleting product');
              }
            })
            .catch((error) => {
              console.error('Error:', error);
              alert('Error deleting product');
            });
        }
      }

      // Image Error Handling
      document
        .querySelector('.product-image')
        .addEventListener('error', function () {
          this.src =
            'https://via.placeholder.com/500x400/e9ecef/6c757d?text=No+Image+Available';
          this.alt = 'No image available';
        });

      // Add to cart animation (optional)
      function addToCart() {
        const button = event.target;
        const originalText = button.innerHTML;

        button.innerHTML =
          '<i class="fas fa-spinner fa-spin me-2"></i>Adding...';
        button.disabled = true;

        setTimeout(() => {
          button.innerHTML = '<i class="fas fa-check me-2"></i>Added!';
          setTimeout(() => {
            button.innerHTML = originalText;
            button.disabled = false;
          }, 1000);
        }, 1000);
      }
    </script>
  </body>
</html>
